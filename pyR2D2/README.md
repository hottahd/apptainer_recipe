# pyR2D2
## 研究の再現性確保

研究であるデータを解析したものの、数年後にオペレーティングシステムなどの変更により、解析の再現が困難になることがある。

そのような事態を避けるために、Apptainer (旧Singularity)を用いたコンテナを用意し、研究データと一緒に保存することにする。

筆者は[pyR2D2](https://github.com/hottahd/pyR2D2)を解析に用いており、このバージョン管理を行いたい。

## 手順

主な手順は以下である。

1. 新しいプロジェクトを始める時はこのレポジトリをクローンし、`pyR2D2`を`py***`としてコピーする。`***`部分は任意
2. `pyR2D2.def`で定義されているようにコンテナを作成する。
    ```shell
    apptainer build --fakeroot pyR2D2.sif pyR2D2.def
    ```
3. コンテナの起動は以下の2通り

    1. シェルを使う場合
        ```shell
        ./pyR2D2.sh shell
        ```
        shell内部でipythonなどを使い、解析を進める。

    2. jupyter notebookを使う場合
        ```shell
        ./pyR2D2.sh run
        ```
        これを実行すると`http://localhost:8888`に実行環境が生成されるので、vs codeのCreate New Jupyter NotebookなどでURLを入力し接続する。

    再現性の観点では、Jupyter Notebookが良いであろう。

4. 研究をまとめて、論文が出版されたら当該ディレクトリをコピーし、`py***_freeze`とし、以降変更できないようにする。

## 考え方

1. 一論文、一コンテナ
2. `.bashrc`, `matplotlibrc`などの設定ファイルはコンテナには含まず、このレポジトリに含む
3. 研究進行中の`pyR2D2`や`pyR2D2.def`の変更は許される

## バックアップ体制

プロジェクトのバックアップを定期的に行うための`rsync_to_dropbox.sh`を用意した。初回実行時にプロジェクト名とバックアップ開始年を記録し、その後 `cron` ジョブを自動登録して6時間ごとにバックアップを実行。
現状では、Dropboxディレクトリに保存しているが、どこかRemote serverに保存するのもいいかもしれない。

---

### 機能

1. **初回実行**:
   - ユーザーにプロジェクト名を入力させるとともに、バックアップ開始年を自動で記録する。
   - `cron` ジョブを自動的に登録し、6時間ごとにバックアップを実行する。

2. **バックアップ**:
   - `rsync` を使用して、指定したディレクトリを `~/Dropbox/Projects/<年>/<プロジェクト名>` にバックアップする。
   - 不要なファイルはバックアップ先から自動的に削除（`--delete` オプション）。

3. **プロジェクト終了**:
   - プロジェクトが完了したら、`project_done` フラグファイルを作成することでバックアップを停止し、`cron` ジョブを削除。

### 使い方

1. スクリプトを実行
    初回実行時にプロジェクト名を入力し、バックアップを開始。

    ```shell
    ./rsync_to_dropbox.sh
    ```
    初回実行時に cron ジョブが自動的に登録され、6時間ごとにバックアップが実行される。

2. プロジェクト終了

    プロジェクトが終了したら、以下のコマンドで `project_done` フラグを作成する。
    ```shell
    touch .project_done
    ```
    次回バックアップ時に cron ジョブが自動的に削除され、バックアップが停止される。
---